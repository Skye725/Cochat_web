<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #2c3e50;
            --background-color: #f5f7fa;
            --card-background: #ffffff;
            --text-color: #333;
            --border-radius: 12px;
            --box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        }

        .message-container {
            height: calc(100vh - 220px);
        }
        .typing-indicator::after {
            content: '...';
            animation: typing 1s infinite;
        }
        @keyframes typing {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }

        #navbar {
            background-color: white;
            padding: 0.7rem 1rem;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 1000;
            width: 100%;
        }

        .nav-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 1rem;
            flex-wrap: nowrap;
            gap: 2rem;
        }

        .nav-links {
            display: flex;
            gap: 0.8rem;
            flex-wrap: nowrap;
            align-items: center;
        }

        .nav-links:first-child {
            margin-right: 0;
            padding-right: 0;
        }

        .nav-links:last-child {
            margin-left: 0;
            padding-left: 2rem;
            border-left: 1px solid rgba(0, 0, 0, 0.1);
        }

        .nav-links a {
            text-decoration: none;
            color: var(--text-color);
            font-weight: 500;
            font-size: 1.1rem;
            padding: 0.4rem 0.8rem;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            white-space: nowrap;
        }

        .nav-links a:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .nav-links a.active {
            background-color: var(--primary-color);
            color: white;
        }

        .nav-links a.active::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 3px;
            background-color: var(--primary-color);
        }

        .nav-links .writing-link {
            background-color: rgba(74, 144, 226, 0.1);
            border: 1px solid rgba(74, 144, 226, 0.2);
        }

        .nav-links .writing-link:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .nav-links .writing-link.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .nav-icon {
            font-size: 1.1rem;
        }

        @media (max-width: 1200px) {
            .nav-content {
                max-width: 100%;
                justify-content: space-between;
                gap: 1rem;
            }

            .nav-links a {
                font-size: 1rem;
                padding: 0.3rem 0.6rem;
            }

            .nav-links {
                gap: 0.5rem;
            }
        }

        .guide-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .guide-content {
            background-color: white;
            margin: 10% auto;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 600px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .guide-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .guide-step {
            margin-bottom: 1rem;
            padding: 1rem;
            background-color: #f7fafc;
            border-radius: 0.5rem;
        }

        .guide-step-title {
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 0.5rem;
        }

        .guide-footer {
            text-align: center;
            margin-top: 1.5rem;
        }

        /* Âü∫Á°ÄÂìçÂ∫îÂºèËÆæÁΩÆ */
        @media (max-width: 768px) {
            .container {
                padding: 0.5rem !important;
                margin-top: 0.5rem !important;
            }

            /* ÂØºËà™Ê†èË∞ÉÊï¥ */
            .nav-content {
                flex-direction: column;
                padding: 0.5rem;
            }

            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
                gap: 0.3rem;
                width: 100%;
            }

            .nav-links:last-child {
                padding-left: 0;
                border-left: none;
                margin-top: 0.5rem;
            }

            .nav-links a {
                font-size: 0.9rem;
                padding: 0.3rem 0.5rem;
                width: calc(50% - 0.5rem); /* ÊØèË°å‰∏§‰∏™ÊåâÈíÆ */
                justify-content: center;
            }

            /* ËÅäÂ§©ÁïåÈù¢Ë∞ÉÊï¥ */
            .message-container {
                height: calc(100vh - 280px) !important;
            }

            /* Ê∂àÊÅØÊ∞îÊ≥°Ë∞ÉÊï¥ */
            .message-container .max-w-\[80\%\] {
                max-width: 90% !important;
            }

            /* ËæìÂÖ•Âå∫ÂüüË∞ÉÊï¥ */
            .p-4 {
                padding: 0.75rem !important;
            }

            #userInput {
                font-size: 1rem;
                padding: 0.5rem;
            }

            /* Ë≠¶ÂëäÊèêÁ§∫Ê°ÜË∞ÉÊï¥ */
            .bg-yellow-50 {
                padding: 0.75rem !important;
                margin-bottom: 0.5rem !important;
            }

            .text-sm {
                font-size: 0.8rem !important;
            }

            /* ÊïÖ‰∫ãÁºñËæëÂå∫ÂüüË∞ÉÊï¥ */
            .story-card textarea {
                min-height: 150px;
                font-size: 0.9rem;
            }

            .story-card button {
                width: 100%;
                margin-top: 0.5rem;
            }

            /* Ê®°ÊÄÅÊ°ÜË∞ÉÊï¥ */
            .guide-content {
                width: 90%;
                margin: 5% auto;
                padding: 1rem;
            }

            .guide-title {
                font-size: 1.2rem;
            }

            .guide-step {
                padding: 0.75rem;
                margin-bottom: 0.75rem;
            }
        }

        /* Ë∂ÖÂ∞èÂ±èÂπïËÆæÂ§áÈÄÇÈÖç */
        @media (max-width: 480px) {
            .nav-links a {
                width: 100%;
                margin-bottom: 0.2rem;
            }

            .page-title {
                font-size: 1.5rem;
            }

            .message-container {
                height: calc(100vh - 320px) !important;
            }

            #userInput {
                font-size: 0.9rem;
            }

            .button-group button {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }
        }

        /* Á°Æ‰øùÂÜÖÂÆπ‰∏ç‰ºöË¢´ÈîÆÁõòÈÅÆÊå° */
        @media (max-height: 600px) {
            .message-container {
                height: calc(100vh - 200px) !important;
            }
        }

        /* ‰ºòÂåñËß¶Êë∏‰ΩìÈ™å */
        @media (hover: none) {
            .nav-links a,
            button,
            .story-card button {
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
            }

            input,
            textarea {
                font-size: 16px !important; /* Èò≤Ê≠¢ iOS Ëá™Âä®Áº©Êîæ */
            }
        }

        /* ÁßªÂä®Á´ØËèúÂçïÊåâÈíÆÊ†∑Âºè */
        .menu-button {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            background-color: var(--primary-color);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 1001;
            cursor: pointer;
            font-weight: 500;
            border: none;
            transition: all 0.3s ease;
        }

        .menu-button i {
            margin-right: 8px;
        }

        /* ÁßªÂä®Á´ØÂØºËà™Ê†èÊ†∑Âºè */
        @media (max-width: 768px) {
            .menu-button {
                display: flex;
                align-items: center;
            }

            #navbar {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.9);
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 1000;
            }

            #navbar.show {
                transform: translateX(0);
            }

            .nav-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 80%;
                height: 100%;
                background-color: white;
                padding: 4rem 1rem 1rem;
                flex-direction: column;
                overflow-y: auto;
            }

            .nav-links {
                flex-direction: column;
                width: 100%;
                gap: 0.5rem;
            }

            .nav-links:last-child {
                border-left: none;
                padding-left: 0;
                margin-top: 1rem;
                padding-top: 1rem;
                border-top: 1px solid rgba(0, 0, 0, 0.1);
            }

            .nav-links a {
                width: 100%;
                padding: 0.8rem;
                font-size: 1rem;
                border-radius: 8px;
                transition: all 0.2s ease;
            }

            .nav-links a:hover {
                background-color: rgba(74, 144, 226, 0.1);
                padding-left: 1.2rem;
            }

            /* ÂÖ≥Èó≠ÊåâÈíÆ */
            .close-menu {
                position: absolute;
                top: 15px;
                right: 15px;
                background: none;
                border: none;
                color: var(--text-color);
                font-size: 1.5rem;
                cursor: pointer;
                z-index: 1002;
                width: 35px;
                height: 35px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: all 0.3s ease;
            }

            .close-menu:hover {
                background-color: rgba(0, 0, 0, 0.05);
            }

            /* Ë∞ÉÊï¥‰∏ªÂÆπÂô®ËæπË∑ù */
            .container {
                padding-top: 60px !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <button class="menu-button" onclick="toggleMenu()">
        <i class="fas fa-bars"></i>
        MENU
    </button>

    <nav id="navbar">
        <div class="nav-content">
            <button class="close-menu" onclick="toggleMenu()">
                <i class="fas fa-times"></i>
            </button>
            <div class="nav-links">
                <a href="/index_login">
                    <i class="nav-icon fas fa-home"></i>
                    Home
                </a>
                <!-- <a href="/inspiration">
                    <i class="nav-icon fas fa-lightbulb"></i>
                    Inspiration
                </a> -->
                <a href="/my_stories">
                    <i class="nav-icon fas fa-book"></i>
                    My Stories
                </a>
                <a href="/daily_log" class="writing-link active">
                    <i class="nav-icon fas fa-calendar-day"></i>
                    Daily Log
                </a>
                <a href="/freewrite" class="writing-link">
                    <i class="nav-icon fas fa-pen"></i>
                    Manual Writing
                </a>
                <a href="/storygenerate" class="writing-link">
                    <i class="nav-icon fas fa-robot"></i>
                    Dialogue Based Writing
                </a>
                <a href="/storywrite" class="writing-link">
                    <i class="nav-icon fas fa-compass"></i>
                    Feedback Based Writing
                </a>
            </div>
            <div class="nav-links">
                <a href="/profile">
                    <i class="nav-icon fas fa-user"></i>
                    Profile
                </a>
                <a href="/logout">
                    <i class="nav-icon fas fa-sign-out-alt"></i>
                    Sign Out
                </a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto max-w-4xl px-4 mt-4">
        <!-- Ê∑ªÂä†Ë≠¶ÂëäÊèêÁ§∫Ê°Ü -->
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4 rounded-lg shadow-sm">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-yellow-700">
                        <strong class="font-medium">NoteÔºö</strong>
                        Do not leave the page while you are writing, as this may cause the chat history to be lost. If you want to save your story, please end the conversation and click Save before leaving.
                    </p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg h-[calc(100vh-140px)] flex flex-col">
            <!-- Header -->
            <div class="p-4 border-b flex items-center space-x-4">
                <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center overflow-hidden">
                    <img src="{{ url_for('static', filename='everyday.png') }}" alt="AI Assistant" class="w-full h-full object-cover">
                </div>
                <div>
                    <h2 class="text-xl font-bold">Daily Log Assistant</h2>
                    <p class="text-sm text-gray-500">Let's record your daily thoughts and experiences together</p>
                </div>
            </div>

            <!-- Chat Messages -->
            <div class="flex-1 overflow-y-auto p-4 message-container" id="messageContainer">
                <div class="space-y-4">
                    <!-- AI Welcome Message -->
                    <div class="flex items-start space-x-4">
                        <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center flex-shrink-0 overflow-hidden">
                            <img src="{{ url_for('static', filename='everyday.png') }}" alt="AI Assistant" class="w-full h-full object-cover">
                        </div>
                        <div class="bg-gray-100 rounded-lg p-4 max-w-[80%]">
                            <p>Hello, {{username}}!üòä How are you feeling today? If you'd like, you can choose one of the options below or just tell me about your mood. No matter what you feel, I'm here to listen. Feel free to share with me‚Äîlet's talk!</p>
                        </div>
                    </div>

                    <!-- Mood Selection Buttons -->
                    <div class="flex flex-wrap justify-center gap-2 mt-4 px-4">
                        <button onclick="sendMessage('I am feeling happy and full of energy today!')" 
                                class="mood-btn bg-white hover:bg-blue-50 text-gray-800 font-semibold py-2 px-4 border border-gray-300 rounded-lg shadow-sm transition-all duration-200 hover:scale-105 text-sm">
                            üåû Happy & full of energy
                        </button>
                        <button onclick="sendMessage('I am feeling okay and calm today.')" 
                                class="mood-btn bg-white hover:bg-blue-50 text-gray-800 font-semibold py-2 px-4 border border-gray-300 rounded-lg shadow-sm transition-all duration-200 hover:scale-105 text-sm">
                            üòå Feeling okay and calm
                        </button>
                        <button onclick="sendMessage('I am feeling a bit tired or stressed today.')" 
                                class="mood-btn bg-white hover:bg-blue-50 text-gray-800 font-semibold py-2 px-4 border border-gray-300 rounded-lg shadow-sm transition-all duration-200 hover:scale-105 text-sm">
                            üòï A bit tired or stressed
                        </button>
                        <button onclick="sendMessage('I am feeling a little sad or down today.')" 
                                class="mood-btn bg-white hover:bg-blue-50 text-gray-800 font-semibold py-2 px-4 border border-gray-300 rounded-lg shadow-sm transition-all duration-200 hover:scale-105 text-sm">
                            üò¢ Feeling a little sad or down
                        </button>
                        <button onclick="sendMessage('I am not sure how I feel, just want to chat.')" 
                                class="mood-btn bg-white hover:bg-blue-50 text-gray-800 font-semibold py-2 px-4 border border-gray-300 rounded-lg shadow-sm transition-all duration-200 hover:scale-105 text-sm">
                            üò∂ Not sure, just want to chat
                        </button>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 border-t">
                <form id="chatForm" class="flex space-x-4">
                    <input type="text" id="userInput" class="flex-1 rounded-lg border border-gray-300 px-4 py-2 focus:outline-none focus:border-blue-500" placeholder="Type your message...">
                    <button type="submit" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                        Send
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div id="guideModal" class="guide-modal">
        <div class="guide-content">
            <h2 class="guide-title">How to Use the Chatbot</h2>

            <div class="guide-step">
                <div class="guide-step-title">1. Start Chatting</div>
                <p>Talk to the chatbot.</p>
            </div>

            <div class="guide-step">
                <div class="guide-step-title">2. Generate Log</div>
                <p>Click "End Coversation" when you're ready to finish the conversation.</p>
            </div>

            <div class="guide-step">
                <div class="guide-step-title">3. Edit Log</div>
                <p>Click "Edit" to modify the generated Log.</p>
            </div>

            <div class="guide-step">
                <div class="guide-step-title">4. Save Log</div>
                <p>Once satisfied, click "Save" to store your Log.</p>
            </div>

            <div class="guide-footer">
                <button onclick="closeGuide()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                    Got it!
                </button>
            </div>
        </div>
    </div>

    <script>
        const messageContainer = document.getElementById('messageContainer');
        const chatForm = document.getElementById('chatForm');
        const userInput = document.getElementById('userInput');

        function addMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start space-x-4 ' + (isUser ? 'justify-end' : '');

            // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´ÁâπÂÆöÊñáÊú¨
            const isStory = !isUser && content.includes("Today's log generated:");

            const iconAndMessage = `
                ${isUser ? '' : `
                    <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center flex-shrink-0 overflow-hidden">
                        <img src="{{ url_for('static', filename='everyday.png') }}" alt="AI Assistant" class="w-full h-full object-cover">
                    </div>
                `}
                <div class="${isUser ? 'bg-blue-500 text-white' : 'bg-gray-100'} rounded-lg p-4 max-w-[80%]">
                    ${isStory ? `
                        <div class="story-card">
                            <p class="story-text">${content}</p>
                            <button onclick="toggleStoryEdit(this)" class="mt-4 text-blue-500 hover:text-blue-700 font-bold text-lg border-2 border-blue-500 px-4 py-2 rounded-lg transition-all duration-300 hover:bg-blue-500 hover:text-white">
                                Click to Edit Story
                            </button>
                            <div class="story-content hidden">
                                <textarea class="w-full p-2 border rounded mb-2 min-h-[200px]">${content}</textarea>
                                <button onclick="saveStory(this)" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                                    Save Story
                                </button>
                            </div>
                        </div>
                    ` : `<p>${content}</p>`}
                    ${!isUser && !isStory ? `
                        <div class="mt-2 flex justify-end">
                            <button onclick="startGenerating()" class="text-sm bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition-colors">
                                End Conversation
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;

            messageDiv.innerHTML = iconAndMessage;
            messageContainer.querySelector('.space-y-4').appendChild(messageDiv);
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        function addTypingIndicator() {
            const indicatorDiv = document.createElement('div');
            indicatorDiv.className = 'flex items-start space-x-4 typing-indicator';
            indicatorDiv.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center flex-shrink-0">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19.8 15.3M14.25 3.104c.251.023.501.05.75.082M19.8 15.3l-1.57.393A9.065 9.065 0 0112 15a9.065 9.065 0 00-6.23-.693L5 14.5m14.8.8l1.402 1.402c1.232 1.232.65 3.318-1.067 3.611A48.309 48.309 0 0112 21c-2.773 0-5.491-.235-8.135-.687-1.718-.293-2.3-2.379-1.067-3.61L5 14.5" />
                    </svg>
                </div>
                <div class="bg-gray-100 rounded-lg p-4 max-w-[80%]">
                    <p>Typing...</p>
                </div>
            `;
            messageContainer.querySelector('.space-y-4').appendChild(indicatorDiv);
            messageContainer.scrollTop = messageContainer.scrollHeight;
            return indicatorDiv;
        }

        // Ê∑ªÂä† sendMessage ÂáΩÊï∞
        function sendMessage(message) {
            // ËÆæÁΩÆËæìÂÖ•Ê°ÜÁöÑÂÄº
            userInput.value = message;
            
            // ÂàõÂª∫Âπ∂Ëß¶ÂèëÊèê‰∫§‰∫ã‰ª∂
            const submitEvent = new Event('submit', {
                'bubbles': true,
                'cancelable': true
            });
            chatForm.dispatchEvent(submitEvent);
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = userInput.value.trim();
            if (!message) return;

            // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
            addMessage(message, true);
            userInput.value = '';

            // Ê∑ªÂä†ËæìÂÖ•ÊåáÁ§∫Âô®
            const typingIndicator = addTypingIndicator();

            try {
                // ÂèëÈÄÅÊ∂àÊÅØÂà∞ÂêéÁ´Ø
                const response = await fetch('/daily_log_chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();

                // ÁßªÈô§ËæìÂÖ•ÊåáÁ§∫Âô®
                typingIndicator.remove();

                // Ê∑ªÂä† AI ÂõûÂ§ç
                const aiResponse = data.fulfillment_response.messages[0].text.text[0];
                addMessage(aiResponse);

            } catch (error) {
                console.error('Error:', error);
                typingIndicator.remove();
                addMessage('sorry, something went wrong');
            }
        });

        // Ê∑ªÂä†ÂºÄÂßãÁîüÊàêÊïÖ‰∫ãÁöÑÂáΩÊï∞
        async function startGenerating() {
            const message = "End the conversation and generate my Log.";

            // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
            addMessage(message, true);

            // Ê∑ªÂä†ËæìÂÖ•ÊåáÁ§∫Âô®
            const typingIndicator = addTypingIndicator();

            try {
                // ÂèëÈÄÅÊ∂àÊÅØÂà∞ÂêéÁ´Ø
                const response = await fetch('/daily_log_chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();

                // ÁßªÈô§ËæìÂÖ•ÊåáÁ§∫Âô®
                typingIndicator.remove();

                // Ê∑ªÂä† AI ÂõûÂ§ç
                const aiResponse = data.fulfillment_response.messages[0].text.text[0];
                addMessage(aiResponse);

            } catch (error) {
                console.error('Error:', error);
                typingIndicator.remove();
                addMessage('sorry, something went wrong');
            }
        }

        // ÂàáÊç¢ÊïÖ‰∫ãÁºñËæëÁä∂ÊÄÅ
        function toggleStoryEdit(button) {
            const storyCard = button.closest('.story-card');
            const storyContent = storyCard.querySelector('.story-content');
            const storyText = storyCard.querySelector('.story-text');
            const textarea = storyCard.querySelector('textarea');

            if (storyContent.classList.contains('hidden')) {
                storyContent.classList.remove('hidden');
                storyText.classList.add('hidden');
                button.textContent = 'Hide Editor';

                // Ê£ÄÊü•Âπ∂Â§ÑÁêÜÊñáÊú¨ÂÜÖÂÆπ
                let content = textarea.value;
                const prefix = "Today's log generated:";
                if (content.includes(prefix)) {
                    // Âà†Èô§ÂâçÁºÄÊñáÊú¨Âπ∂ÂéªÈô§Â§ö‰ΩôÁ©∫Ê†º
                    content = content.substring(content.indexOf(prefix) + prefix.length).trim();
                    textarea.value = content;
                }
            } else {
                storyContent.classList.add('hidden');
                storyText.classList.remove('hidden');
                button.textContent = 'Click to Edit Story';
            }
        }

        // ‰øùÂ≠òÊïÖ‰∫ãÂà∞Êï∞ÊçÆÂ∫ì
        async function saveStory(button) {
            const storyCard = button.closest('.story-card');
            const textarea = storyCard.querySelector('textarea');
            const content = textarea.value;

            // ÂºπÂá∫ËæìÂÖ•Ê°ÜËØ∑Ê±ÇÁî®Êà∑ËæìÂÖ•Ê†áÈ¢ò
            const title = await promptForTitle();
            if (!title) {
                return; // Â¶ÇÊûúÁî®Êà∑ÂèñÊ∂àÊàñÊú™ËæìÂÖ•Ê†áÈ¢òÔºåÂàôÁªàÊ≠¢‰øùÂ≠ò
            }

            try {
                const response = await fetch('/save_story', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title,
                        content: content,
                        writing_mode: 'daily_log'
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to save story');
                }

                const data = await response.json();
                if (data.success) {
                    alert('Story saved successfully!');
                    // Êõ¥Êñ∞ÊòæÁ§∫ÁöÑÊñáÊú¨
                    const storyText = storyCard.querySelector('.story-text');
                    storyText.textContent = content;
                    // ÈöêËóèÁºñËæëÂô®
                    toggleStoryEdit(storyCard.querySelector('button'));
                } else {
                    throw new Error(data.error || 'Failed to save story');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to save story: ' + error.message);
            }
        }

        // Ê∑ªÂä†Êñ∞ÂáΩÊï∞Áî®‰∫éËé∑ÂèñÊ†áÈ¢ò
        function promptForTitle() {
            return new Promise((resolve) => {
                // ÂàõÂª∫Ê®°ÊÄÅÊ°Ü
                const modalHtml = `
                    <div id="titleModal" class="guide-modal" style="display: flex;">
                        <div class="guide-content">
                            <h2 class="guide-title">Enter Story Title</h2>
                            <div style="margin: 20px 0;">
                                <input type="text" id="storyTitleInput" 
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                    placeholder="Enter your story title...">
                            </div>
                            <div class="guide-footer">
                                <button id="cancelTitleBtn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors mr-2">
                                    Cancel
                                </button>
                                <button id="saveTitleBtn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                                    Save
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                // Ê∑ªÂä†Ê®°ÊÄÅÊ°ÜÂà∞È°µÈù¢
                document.body.insertAdjacentHTML('beforeend', modalHtml);

                const modal = document.getElementById('titleModal');
                const input = document.getElementById('storyTitleInput');
                const saveBtn = document.getElementById('saveTitleBtn');
                const cancelBtn = document.getElementById('cancelTitleBtn');

                // Â§ÑÁêÜ‰øùÂ≠òÊåâÈíÆÁÇπÂáª
                saveBtn.onclick = () => {
                    const title = input.value.trim();
                    if (title) {
                        modal.remove();
                        resolve(title);
                    } else {
                        alert('Please enter a title for your story.');
                    }
                };

                // Â§ÑÁêÜÂèñÊ∂àÊåâÈíÆÁÇπÂáª
                cancelBtn.onclick = () => {
                    modal.remove();
                    resolve(null);
                };

                // Â§ÑÁêÜÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®
                modal.onclick = (event) => {
                    if (event.target === modal) {
                        modal.remove();
                        resolve(null);
                    }
                };

                // ËÅöÁÑ¶ËæìÂÖ•Ê°Ü
                input.focus();
            });
        }

        // Ê∑ªÂä†Êñ∞ÁöÑÂáΩÊï∞
        function showGuide() {
            document.getElementById('guideModal').style.display = 'block';
        }

        function closeGuide() {
            document.getElementById('guideModal').style.display = 'none';
            localStorage.setItem('chatbotGuideShown', 'true');
        }

        // Âú®È°µÈù¢Âä†ËΩΩÊó∂Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊòæÁ§∫ÂºïÂØº
        window.addEventListener('load', function() {
            if (!localStorage.getItem('chatbotGuideShown')) {
                showGuide();
            }
        });

        // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®Êó∂ÂÖ≥Èó≠
        window.onclick = function(event) {
            const modal = document.getElementById('guideModal');
            if (event.target == modal) {
                closeGuide();
            }
        }

        let lastScrollTop = 0;
        const menuButton = document.querySelector('.menu-button');
        const navbar = document.getElementById('navbar');

        // ÁõëÂê¨ÊªöÂä®‰∫ã‰ª∂
        window.addEventListener('scroll', () => {
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

            // Âêë‰∏ãÊªöÂä®Êó∂ÈöêËóèËèúÂçïÊåâÈíÆÔºåÂêë‰∏äÊªöÂä®Êó∂ÊòæÁ§∫
            if (scrollTop > lastScrollTop) {
                menuButton.style.transform = 'translateY(100px)';
            } else {
                menuButton.style.transform = 'translateY(0)';
            }

            lastScrollTop = scrollTop;
        });

        // ÂàáÊç¢ËèúÂçïÊòæÁ§∫/ÈöêËóè
        function toggleMenu() {
            navbar.classList.toggle('show');

            // Â¶ÇÊûúËèúÂçïÂ±ïÂºÄÔºåÁ¶ÅÊ≠¢ËÉåÊôØÊªöÂä®
            if (navbar.classList.contains('show')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }

        // ÁÇπÂáªÂØºËà™ÈìæÊé•Êó∂ÂÖ≥Èó≠ËèúÂçï
        document.querySelectorAll('.nav-links a').forEach(link => {
            link.addEventListener('click', () => {
                navbar.classList.remove('show');
                document.body.style.overflow = '';
            });
        });

        // ÁÇπÂáªËèúÂçïÂ§ñÈÉ®Âå∫ÂüüÊó∂ÂÖ≥Èó≠ËèúÂçï
        navbar.addEventListener('click', (e) => {
            if (e.target === navbar) {
                navbar.classList.remove('show');
                document.body.style.overflow = '';
            }
        });
    </script>
</body>
</html>