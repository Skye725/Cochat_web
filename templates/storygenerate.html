<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #2c3e50;
            --background-color: #f5f7fa;
            --card-background: #ffffff;
            --text-color: #333;
            --border-radius: 12px;
            --box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        }

        .message-container {
            height: calc(100vh - 220px);
        }
        .typing-indicator::after {
            content: '...';
            animation: typing 1s infinite;
        }
        @keyframes typing {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }

        #navbar {
            background-color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-links {
            display: flex;
            gap: 1.5rem;
        }

        .nav-links a {
            text-decoration: none;
            color: var(--text-color);
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-links a:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .nav-links a.active {
            background-color: var(--primary-color);
            color: white;
        }

        /* 可选：添加一个小指示器 */
        .nav-links a.active::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 3px;
            background-color: var(--primary-color);
        }

        @media (max-width: 768px) {
            .nav-content {
                flex-direction: column;
                gap: 1rem;
            }

            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        .guide-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .guide-content {
            background-color: white;
            margin: 10% auto;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 600px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .guide-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .guide-step {
            margin-bottom: 1rem;
            padding: 1rem;
            background-color: #f7fafc;
            border-radius: 0.5rem;
        }

        .guide-step-title {
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 0.5rem;
        }

        .guide-footer {
            text-align: center;
            margin-top: 1.5rem;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Navigation Bar -->
    <div id="navbar">
        <div class="nav-content">
            <div class="nav-links">
                <a href="/index_login">Home</a>
                <a href="/my_stories">Story Base</a>
                <a href="/freewrite">Manual Writing</a>
                <a href="/storygenerate" class="active">Automated Writing</a>
                <a href="/storywrite">Guided Writing</a>
            </div>
            <div class="nav-links">
                <a href="/profile">Profile</a>
                <a href="/logout">Sign Out</a>
            </div>
        </div>
    </div>

    <div class="container mx-auto max-w-4xl px-4 mt-4">
        <div class="bg-white rounded-lg shadow-lg h-[calc(100vh-140px)] flex flex-col">
            <!-- Header -->
            <div class="p-4 border-b flex items-center space-x-4">
                <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center overflow-hidden">
                    <img src="{{ url_for('static', filename='icon.jpg') }}" alt="AI Assistant" class="w-full h-full object-cover">
                </div>
                <div>
                    <h2 class="text-xl font-bold">Story Assistant</h2>
                    <p class="text-sm text-gray-500">Always here to help, tell me about what you want to write and I will generate stories for you</p>
                </div>
            </div>

            <!-- Chat Messages -->
            <div class="flex-1 overflow-y-auto p-4 message-container" id="messageContainer">
                <div class="space-y-4">
                    <!-- AI Welcome Message -->
                    <div class="flex items-start space-x-4">
                        <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center flex-shrink-0 overflow-hidden">
                            <img src="{{ url_for('static', filename='icon.jpg') }}" alt="AI Assistant" class="w-full h-full object-cover">
                        </div>
                        <div class="bg-gray-100 rounded-lg p-4 max-w-[80%]">
                            <p>Hello, {{username}}! I am here to listen to your story. Here, we will have a relaxed conversation and collect your basic information. I will ask you one question at a time until I have all the information I want to know. Afterwards, I will encourage you to share your story and help you revise it to make it more authentic and encouraging. Please feel free to relax and start our communication! What story you would like to share today?</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 border-t">
                <form id="chatForm" class="flex space-x-4">
                    <input type="text" id="userInput" class="flex-1 rounded-lg border border-gray-300 px-4 py-2 focus:outline-none focus:border-blue-500" placeholder="Type your message...">
                    <button type="submit" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                        Send
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div id="guideModal" class="guide-modal">
        <div class="guide-content">
            <h2 class="guide-title">How to Use the Chatbot</h2>
            
            <div class="guide-step">
                <div class="guide-step-title">1. Start Chatting</div>
                <p>Talk to the chatbot.</p>
            </div>

            <div class="guide-step">
                <div class="guide-step-title">2. Generate Story</div>
                <p>Click "Generate" when you're ready to finish the conversation.</p>
            </div>

            <div class="guide-step">
                <div class="guide-step-title">3. Edit Story</div>
                <p>Click "Edit" to modify the generated story.</p>
            </div>

            <div class="guide-step">
                <div class="guide-step-title">4. Save Story</div>
                <p>Once satisfied, click "Save" to store your story.</p>
            </div>

            <div class="guide-footer">
                <button onclick="closeGuide()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                    Got it!
                </button>
            </div>
        </div>
    </div>

    <script>
        const messageContainer = document.getElementById('messageContainer');
        const chatForm = document.getElementById('chatForm');
        const userInput = document.getElementById('userInput');

        function addMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start space-x-4 ' + (isUser ? 'justify-end' : '');
            
            // 检查是否包含特定文本
            const isStory = !isUser && content.includes("I summarized the previous chat between us and generated a story");
            
            const iconAndMessage = `
                ${isUser ? '' : `
                    <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center flex-shrink-0 overflow-hidden">
                        <img src="{{ url_for('static', filename='icon.jpg') }}" alt="AI Assistant" class="w-full h-full object-cover">
                    </div>
                `}
                <div class="${isUser ? 'bg-blue-500 text-white' : 'bg-gray-100'} rounded-lg p-4 max-w-[80%]">
                    ${isStory ? `
                        <div class="story-card">
                            <p class="story-text">${content}</p>
                            <button onclick="toggleStoryEdit(this)" class="mt-4 text-blue-500 hover:text-blue-700 font-bold text-lg border-2 border-blue-500 px-4 py-2 rounded-lg transition-all duration-300 hover:bg-blue-500 hover:text-white">
                                Click to Edit Story
                            </button>
                            <div class="story-content hidden">
                                <textarea class="w-full p-2 border rounded mb-2 min-h-[200px]">${content}</textarea>
                                <button onclick="saveStory(this)" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                                    Save Story
                                </button>
                            </div>
                        </div>
                    ` : `<p>${content}</p>`}
                    ${!isUser && !isStory ? `
                        <div class="mt-2 flex justify-end">
                            <button onclick="startGenerating()" class="text-sm bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition-colors">
                                Generate
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
            
            messageDiv.innerHTML = iconAndMessage;
            messageContainer.querySelector('.space-y-4').appendChild(messageDiv);
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        function addTypingIndicator() {
            const indicatorDiv = document.createElement('div');
            indicatorDiv.className = 'flex items-start space-x-4 typing-indicator';
            indicatorDiv.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center flex-shrink-0">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19.8 15.3M14.25 3.104c.251.023.501.05.75.082M19.8 15.3l-1.57.393A9.065 9.065 0 0112 15a9.065 9.065 0 00-6.23-.693L5 14.5m14.8.8l1.402 1.402c1.232 1.232.65 3.318-1.067 3.611A48.309 48.309 0 0112 21c-2.773 0-5.491-.235-8.135-.687-1.718-.293-2.3-2.379-1.067-3.61L5 14.5" />
                    </svg>
                </div>
                <div class="bg-gray-100 rounded-lg p-4 max-w-[80%]">
                    <p>Typing...</p>
                </div>
            `;
            messageContainer.querySelector('.space-y-4').appendChild(indicatorDiv);
            messageContainer.scrollTop = messageContainer.scrollHeight;
            return indicatorDiv;
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = userInput.value.trim();
            if (!message) return;

            // 添加用户消息
            addMessage(message, true);
            userInput.value = '';

            // 添加输入指示器
            const typingIndicator = addTypingIndicator();

            try {
                // 发送消息到后端
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                
                // 移除输入指示器
                typingIndicator.remove();
                
                // 添加 AI 回复
                // 从返回的数据中提取回复文本
                const aiResponse = data.fulfillment_response.messages[0].text.text[0];
                addMessage(aiResponse);

            } catch (error) {
                console.error('Error:', error);
                typingIndicator.remove();
                addMessage('sorry, something went wrong');
            }
        });

        // 添加开始生成故事的函数
        async function startGenerating() {
            const message = "Start generating the story";
            
            // 添加用户消息
            addMessage(message, true);

            // 添加输入指示器
            const typingIndicator = addTypingIndicator();

            try {
                // 发送消息到后端
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                
                // 移除输入指示器
                typingIndicator.remove();
                
                // 添加 AI 回复
                const aiResponse = data.fulfillment_response.messages[0].text.text[0];
                addMessage(aiResponse);

            } catch (error) {
                console.error('Error:', error);
                typingIndicator.remove();
                addMessage('sorry, something went wrong');
            }
        }

        // 切换故事编辑状态
        function toggleStoryEdit(button) {
            const storyCard = button.closest('.story-card');
            const storyContent = storyCard.querySelector('.story-content');
            const storyText = storyCard.querySelector('.story-text');
            
            if (storyContent.classList.contains('hidden')) {
                storyContent.classList.remove('hidden');
                storyText.classList.add('hidden');
                button.textContent = 'Hide Editor';
            } else {
                storyContent.classList.add('hidden');
                storyText.classList.remove('hidden');
                button.textContent = 'Click to Edit Story';
            }
        }

        // 保存故事到数据库
        async function saveStory(button) {
            const storyCard = button.closest('.story-card');
            const textarea = storyCard.querySelector('textarea');
            const content = textarea.value;

            try {
                const response = await fetch('/save_story', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: 'Generated Story',  // 可以根据需要修改标题
                        content: content
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to save story');
                }

                const data = await response.json();
                if (data.success) {
                    alert('Story saved successfully!');
                    // 更新显示的文本
                    const storyText = storyCard.querySelector('.story-text');
                    storyText.textContent = content;
                    // 隐藏编辑器
                    toggleStoryEdit(storyCard.querySelector('button'));
                } else {
                    throw new Error(data.error || 'Failed to save story');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to save story: ' + error.message);
            }
        }

        // 添加新的函数
        function showGuide() {
            document.getElementById('guideModal').style.display = 'block';
        }

        function closeGuide() {
            document.getElementById('guideModal').style.display = 'none';
            localStorage.setItem('chatbotGuideShown', 'true');
        }

        // 在页面加载时检查是否需要显示引导
        window.addEventListener('load', function() {
            if (!localStorage.getItem('chatbotGuideShown')) {
                showGuide();
            }
        });

        // 点击模态框外部时关闭
        window.onclick = function(event) {
            const modal = document.getElementById('guideModal');
            if (event.target == modal) {
                closeGuide();
            }
        }
    </script>
</body>
</html>